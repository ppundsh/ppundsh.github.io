<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-circle.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="KoUtfkPM92_pO2Q42heYL6rswPDbdQo1Q0HKel728Vk">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文記錄自V2Ray配置指南，加上一些些個人註解，非常感謝此文的作者。">
<meta name="keywords" content="APP,GFW">
<meta property="og:type" content="article">
<meta property="og:title" content="V2Ray 記錄">
<meta property="og:url" content="https://ppundsh.github.io/posts/e457/index.html">
<meta property="og:site_name" content="Flymia 凡事用心之事">
<meta property="og:description" content="本文記錄自V2Ray配置指南，加上一些些個人註解，非常感謝此文的作者。">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2018-05-13T15:07:02.311Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="V2Ray 記錄">
<meta name="twitter:description" content="本文記錄自V2Ray配置指南，加上一些些個人註解，非常感謝此文的作者。">



  <link rel="alternate" href="/atom.xml" title="Flymia 凡事用心之事" type="application/atom+xml">




  <link rel="canonical" href="https://ppundsh.github.io/posts/e457/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>V2Ray 記錄 | Flymia 凡事用心之事</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-TW">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Flymia 凡事用心之事</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">科技、藝術、工藝</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切換導航欄">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首頁</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>標籤</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>歸檔</a>
</li>

      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜尋</a>
        </li>
      
    </ul>
  

  
    

    
    
      
      
    
      
      
    
      
      
    
    

  


  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜尋..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  


 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ppundsh.github.io/posts/e457/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Flymia">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Flymia 凡事用心之事">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">V2Ray 記錄</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-04-15T18:52:53+08:00">2018-04-15</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新於：</span>
              
              <time title="更新於" itemprop="dateModified" datetime="2018-05-13T23:07:02+08:00">2018-05-13</time>
            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">文章字數：</span>
                
                <span title="文章字數">52k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">閱讀時間&asymp;</span>
                
                <span title="閱讀時間">4:22</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文記錄自<a href="https://toutyrater.github.io/" rel="external nofollow noopener noreferrer" target="_blank">V2Ray配置指南</a>，加上一些些個人註解，非常感謝此文的作者。<br><a id="more"></a></p>
<h2 id="常用-Linux-指令"><a href="#常用-Linux-指令" class="headerlink" title="常用 Linux 指令"></a>常用 Linux 指令</h2><p>查看時間</p>
<pre><code>date -R
</code></pre><p>更改時區</p>
<pre><code>cp /usr/share/zoneinfo/Asia/Taipei /etc/localtime
</code></pre><p>查看 CentOS 版本</p>
<pre><code>cat /etc/redhat-release
</code></pre><p>查看源</p>
<pre><code>cat /etc/apt/sources.list
</code></pre><p>查看自已的 ip</p>
<pre><code>ifconfig.me
</code></pre><hr>
<h2 id="常用-v2ray-指令"><a href="#常用-v2ray-指令" class="headerlink" title="常用 v2ray 指令"></a>常用 v2ray 指令</h2><p>編緝設定檔</p>
<pre><code>vi /etc/v2ray/config.json
</code></pre><p>控制</p>
<pre><code>service v2ray start|stop|status|reload|restart|force-reload
</code></pre><p>測試設定檔</p>
<pre><code>/usr/bin/v2ray/v2ray -test -config /etc/v2ray/config.json
</code></pre><hr>
<h2 id="常用-Nginx-指令"><a href="#常用-Nginx-指令" class="headerlink" title="常用 Nginx 指令"></a>常用 Nginx 指令</h2><pre><code>vi /etc/nginx/nginx.conf
nginx -t
systemctl reload nginx

less /var/log/nginx/access.log
</code></pre><p>參考[^12}</p>
<hr>
<h2 id="CentOS-7-安裝-V2Ray"><a href="#CentOS-7-安裝-V2Ray" class="headerlink" title="CentOS 7 安裝 V2Ray"></a>CentOS 7 安裝 V2Ray</h2><p>一行結束</p>
<pre><code>bash &lt;(curl -L -s https://install.direct/go.sh)
</code></pre><p>此脚本会自动安装以下文件：</p>
<pre><code>/usr/bin/v2ray/v2ray：V2Ray 程序；
/usr/bin/v2ray/v2ctl：V2Ray 工具；
/etc/v2ray/config.json：配置文件；
/usr/bin/v2ray/geoip.dat：IP 数据文件
/usr/bin/v2ray/geosite.dat：域名数据文件
</code></pre><p>此脚本会配置自动运行脚本。自动运行脚本会在系统重启之后，自动运行 V2Ray。目前自动运行脚本只支持带有 Systemd 的系统，以及 Debian / Ubuntu 全系列。</p>
<p>运行脚本位于系统的以下位置：</p>
<pre><code>/etc/systemd/system/v2ray.service: Systemd
/etc/init.d/v2ray: SysV
</code></pre><p>脚本运行完成后，你需要：</p>
<p>编辑 /etc/v2ray/config.json 文件来配置你需要的代理方式；<br>运行 service v2ray start 来启动 V2Ray 进程；<br>之后可以使用 service v2ray start|stop|status|reload|restart|force-reload 控制 V2Ray 的运行。</p>
<p>將 Clinet 端貼上預設設定即可：</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    "port": 1080,  // SOCKS 代理端口，在浏览器中需配置代理并指向这个端口</div><div class="line">    "listen": "127.0.0.1",</div><div class="line">    "protocol": "socks",</div><div class="line">    "domainOverride": ["tls","http"], // “識別相應協定的流量，並根據流量內容重置所請求的目標”，簡單說這東西就是從網路流量中識別出域名。手機用戶無法使用 chinasites 時使用。</div><div class="line">    "settings": &#123;</div><div class="line">      "auth": "noauth",  //socks的認證設置，noauth 代表不認證，由於 socks 通常在客戶端使用，所以這裡不認證</div><div class="line">      "udp": true</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "vmess",</div><div class="line">    "settings": &#123;</div><div class="line">      "vnext": [&#123;</div><div class="line">        "address": "我是SERVER IP", // 服务器地址，请修改为你自己的服务器 ip 或域名</div><div class="line">        "port": 我是端口,  // 服务器端口</div><div class="line">        "users": [</div><div class="line">          &#123;</div><div class="line">            "id": "我是UUID", // 用戶 ID，必須與伺服器端配置相同</div><div class="line">            "alterID": 64 // 此處的值也應當與伺服器相同，認證用值越大會使用 V2Ray 佔用更多的記憶體。對於一般用戶來說，alterId 的值設為 30 到 100 之間應該是比較合適的。</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outboundDetour": [&#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "tag": "direct", //如果要使用路由，這個 tag 是一定要有的，在這裡 direct 就是 freedom 的一個標號，在路由中說 direct V2Ray 就知道是這裡的 freedom 了</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;],</div><div class="line">  "routing": &#123;</div><div class="line">    "strategy": "rules",</div><div class="line">    "settings": &#123;</div><div class="line">      "domainStrategy": "IPOnDemand",</div><div class="line">      "rules": [&#123;</div><div class="line">        "type": "field",</div><div class="line">        "ip": [</div><div class="line">          "0.0.0.0/8",</div><div class="line">          "10.0.0.0/8",</div><div class="line">          "100.64.0.0/10",</div><div class="line">          "127.0.0.0/8",</div><div class="line">          "169.254.0.0/16",</div><div class="line">          "172.16.0.0/12",</div><div class="line">          "192.0.0.0/24",</div><div class="line">          "192.0.2.0/24",</div><div class="line">          "192.168.0.0/16",</div><div class="line">          "198.18.0.0/15",</div><div class="line">          "198.51.100.0/24",</div><div class="line">          "203.0.113.0/24",</div><div class="line">          "::1/128",</div><div class="line">          "fc00::/7",</div><div class="line">          <span class="string">"fe80::/10"</span></div><div class="line">        ],</div><div class="line">        "outboundTag": "direct"</div><div class="line">      &#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>Sever 端</p>
<figure class="highlight json"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"log"</span> : &#123;</div><div class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</div><div class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">15674</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"12713195-43cd-4cce-8dd6-739c8244a519"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outboundDetour"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"blocked"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"routing"</span>: &#123;</div><div class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"rules"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [</div><div class="line">            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>UUID<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> 生成指令<br>    cat /proc/sys/kernel/random/uuid </p>
<p>多IP</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></div><div class="code"><pre><div class="line">"clients": [</div><div class="line">  &#123;"id": "xxxx", "alterId": 64&#125;,</div><div class="line">  &#123;<span class="attr">"id"</span>: <span class="string">"yyyy"</span>, <span class="attr">"alterId"</span>: <span class="number">64</span>&#125;</div><div class="line">]</div></pre></div></div></figure>
<hr>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>作者<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup><br>JSON 所有標點符號都要用半角符號（英文符號）<br>所有字串都要加雙引號 “ “，鍵是字串，所以鍵也要加雙引號，數字不用加雙引號<br>布爾類型也不用加雙引號，布爾值只有兩個就是 true 和 false，意思就是真和假<br>對象沒有順序，即大括弧 {} 括起來的內容順序是怎麼樣都沒關係</p>
<hr>
<h3 id="中國地區不翻牆"><a href="#中國地區不翻牆" class="headerlink" title="中國地區不翻牆"></a>中國地區不翻牆</h3><p>Client 端的 Route 改為<br><figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></div><div class="code"><pre><div class="line">"routing": &#123;</div><div class="line">  "strategy": "rules",  //固定格式</div><div class="line">  "settings": &#123;</div><div class="line">    "domainStrategy": "IPIfNonMatch",</div><div class="line">    "rules": [</div><div class="line">      &#123;</div><div class="line">        "type": "chinasites",  //中國的網站域名</div><div class="line">        "outboundTag": "direct"</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        "type": "chinaip",  //中國的IP</div><div class="line">        "outboundTag": "direct"</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<hr>
<h3 id="廣告過濾"><a href="#廣告過濾" class="headerlink" title="廣告過濾"></a>廣告過濾</h3><p>Client 端<br><figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></div><div class="code"><pre><div class="line">"routing": &#123;</div><div class="line">   "strategy": "rules",</div><div class="line">   "settings": &#123;</div><div class="line">     "domainStrategy": "IPIfNonMatch",</div><div class="line">     "rules": [</div><div class="line">       &#123;</div><div class="line">         <span class="attr">"domain"</span>: [</div><div class="line">           <span class="string">"tanx.com"</span>,</div><div class="line">           <span class="string">"googeadsserving.cn"</span>,</div><div class="line">           <span class="string">"baidu.com"</span></div><div class="line">         ],</div><div class="line">         <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">         <span class="attr">"outboundTag"</span>: <span class="string">"adblock"</span>       </div><div class="line">       &#125;,</div><div class="line">       &#123;</div><div class="line">         <span class="attr">"domain"</span>: [</div><div class="line">           <span class="string">"amazon.com"</span>,</div><div class="line">           <span class="string">"microsoft.com"</span>,</div><div class="line">           <span class="string">"jd.com"</span>,</div><div class="line">           <span class="string">"youku.com"</span>,</div><div class="line">           <span class="string">"baidu.com"</span></div><div class="line">         ],</div><div class="line">         <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">         <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">       &#125;,</div><div class="line">       &#123;</div><div class="line">         <span class="attr">"type"</span>: <span class="string">"chinasites"</span>,</div><div class="line">         <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">       &#125;,</div><div class="line">       &#123;</div><div class="line">         <span class="attr">"type"</span>: <span class="string">"chinaip"</span>,</div><div class="line">         <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">       &#125;</div><div class="line">     ]</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></div></div></figure></p>
<p>在第一個規則中，域名包含有 tanx.com 或 baidu.com 的就會被阻止連接。在第二個規則當中，域名中包含有 amazon.com 或 microsoft.com 或 youku.com 或 baidu.com 的會直連。有一個問題大家發現沒有，兩個規則都有 baidu.com ，那麼會執行哪個呢？答案是只會執行第一個，原因是：</p>
<ol>
<li>規則是放在 routing.settings.rules 這個陣列當中，陣列的內容是有順序的，也就是說在這裡規則是有順序的，匹配規則時是從上往下匹配</li>
<li>當路由匹配到一個規則時就會跳出匹配而不會對之後的規則進行匹配</li>
</ol>
<hr>
<h3 id="inbound-outbound-和-inboundDetour-outboundDetour-的區別"><a href="#inbound-outbound-和-inboundDetour-outboundDetour-的區別" class="headerlink" title="inbound / outbound 和 inboundDetour / outboundDetour 的區別"></a>inbound / outbound 和 inboundDetour / outboundDetour 的區別</h3><p>inbound 和 inboundDetour 的格式形如：</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></div><div class="code"><pre><div class="line">"inbound": &#123;</div><div class="line">  "port": 1080,</div><div class="line">  "listen": "127.0.0.1",</div><div class="line">  "protocol": "協定名稱",</div><div class="line">  "settings": &#123;&#125;,</div><div class="line">  "streamSettings": &#123;&#125;,</div><div class="line">  "allowPassive": false,</div><div class="line">  "tag": "標識"</div><div class="line">&#125;,</div><div class="line">"inboundDetour": [</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">2080</span>,</div><div class="line">    <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"協定名稱"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"allowPassive"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"tag"</span>: <span class="string">"標識"</span>,</div><div class="line">    <span class="attr">"allocate"</span>: &#123;</div><div class="line">      <span class="attr">"strategy"</span>: <span class="string">"always"</span>,</div><div class="line">      <span class="attr">"refresh"</span>: <span class="number">5</span>,</div><div class="line">      <span class="attr">"concurrency"</span>: <span class="number">3</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">3080</span>,</div><div class="line">    <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"協定名稱"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"allowPassive"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"tag"</span>: <span class="string">"標識"</span>,</div><div class="line">    <span class="attr">"allocate"</span>: &#123;</div><div class="line">      <span class="attr">"strategy"</span>: <span class="string">"always"</span>,</div><div class="line">      <span class="attr">"refresh"</span>: <span class="number">5</span>,</div><div class="line">      <span class="attr">"concurrency"</span>: <span class="number">3</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">]</div></pre></div></div></figure>
<p>可以很明顯地看出來，inbound 和 inboundDetour 基本是一樣的，只不過 inboundDetour 是 inbound 的集合。還有一點不同的是 inboundDetour 多了一個 allocate 參數，這是只有在動態端口才會用到的參數，如果不配置動態端口 inboundDetour 和 inbound 無異。</p>
<p>即有兩點不同：</p>
<p>配置中 inbound 只能並且必須設置一個傳入的配置，而 inboundDetour 可以設置任意多個傳入配置<br>inboundDetour 的傳入配置多了一個給動態端口用的 allocate 參數<br>接著是傳出，outbound 和 outboundDetour 格式形如:</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></div><div class="code"><pre><div class="line">"outbound": &#123;</div><div class="line">  "sendThrough": "0.0.0.0",</div><div class="line">  "protocol": "協定名稱",</div><div class="line">  "settings": &#123;&#125;,</div><div class="line">  "tag": "標識",</div><div class="line">  "streamSettings": &#123;&#125;,</div><div class="line">  "proxySettings": &#123;</div><div class="line">    "tag": "another-outbound-tag"</div><div class="line">  &#125;  </div><div class="line">&#125;,</div><div class="line">"outboundDetour": [</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"sendThrough"</span>: <span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"協定名稱"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"tag"</span>: <span class="string">"標識"</span>,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"proxySettings"</span>: &#123;</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"another-outbound-tag"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">"sendThrough"</span>: <span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"協定名稱"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"tag"</span>: <span class="string">"標識"</span>,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"proxySettings"</span>: &#123;</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"another-outbound-tag"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">]</div></pre></div></div></figure>
<p>單純從配置格式來看，outbound 和 outboundDetour 沒有任何區別。但是實際上 outbound 和 outboundDetour 也有兩點不同：</p>
<p>配置中 outbound 只能並且必須設置一個傳出的配置，而 outboundDetour 可以設置任意多個傳出配置（實際上不可能任意多）<br>當沒有配置路由規則或者路由沒有匹配的情況下，默認由 outbound 將資料包發出去。<br>在上面給出的傳入和傳出配置格式當中，有一些參數不曾提到過，主要是因為一般情況下使用 V2Ray 默認設置即可</p>
<hr>
<h2 id="V2Ray-高級設置"><a href="#V2Ray-高級設置" class="headerlink" title="V2Ray 高級設置"></a>V2Ray 高級設置</h2><p>V2Ray 的相比其他工具有一大優點是可以自行選擇傳輸層<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup>的形式，也就是說 V2Ray 伺服器和客戶端之間的傳輸的流量格式我們是可以選擇的。如我們可以選擇偽裝成 HTTP(TCP) 流量，如果使用了 mKCP 也可以偽裝成 BT 下載、視頻通話、微信視頻通話。也可以選擇使用 WebSokcs 或者 TLS。以上這個都是傳輸層的配置決定的。</p>
<p>V2Ray 中傳輸層配置在 transport 裡設定，也可以在各個 inbound/outbound 中的 streamSettings 設定。這兩者的區別是 inbound/outbound 的 streamSettings 只對當前的 inbound/outbound 有效 (分連接配置)，不影響其他的 inbound/outbound 的傳輸層配置，而 transport 是全局的，對整個配置所有的 inbound 和 outbound 都有效 (全局配置)，如果一個 inbound/outbound 中設定了 streamSettings，transport 的設定不會影響這個 inbound/outbound。</p>
<p>在本篇當中，大部分內容都涉及到了傳輸層，關於這部分內容使用的是 inbound/outbound 的 streamSettings(分連接配置)，同時也建議大家使用分連接配置。因為如果你在全局配置中開啟了偽裝功能，會導致瀏覽器或者其他軟件無法與 V2Ray 通信！這不是 bug，只是因為你設置不當。</p>
<hr>
<h3 id="Mux-多路復用-multiplexing"><a href="#Mux-多路復用-multiplexing" class="headerlink" title="Mux 多路復用 (multiplexing)"></a>Mux 多路復用 (multiplexing)</h3><p>將多個 TCP 連線合併為一條，可節省資源，提高並發能力。</p>
<p>Mux 只需在客戶端開啟，伺服器會自動識別，所以只給客戶端的配置。只要在 outbound 或 outboundDetour 加入 “mux”: {“enabled”: true} 即可：</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    "port": 1080, // 監聽端口</div><div class="line">    "protocol": "socks", // 入口協定為 SOCKS 5</div><div class="line">    "domainOverride": ["tls","http"],</div><div class="line">    "settings": &#123;</div><div class="line">      "auth": "noauth"  // 不認證</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "vmess", // 出口協定</div><div class="line">    "settings": &#123;</div><div class="line">      "vnext": [</div><div class="line">        &#123;</div><div class="line">          "address": "serveraddr.com", // 伺服器位址，請修改為你自己的伺服器 ip 或域名</div><div class="line">          "port": 16823,  // 伺服器端口</div><div class="line">          "users": [</div><div class="line">            &#123;</div><div class="line">              "id": "b831381d-6324-4d53-ad4f-8cda48b30811",  // 用戶 ID，必須與伺服器端配置相同</div><div class="line">              "alterId": 64 // 此處的值也應當與伺服器相同</div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "mux": &#123;"enabled": true&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<hr>
<h3 id="mKCP"><a href="#mKCP" class="headerlink" title="mKCP"></a>mKCP</h3><p>V2Ray 引入了 KCP 傳輸協定，稱為 mKCP，相對於常規的 TCP 來說，mKCP 在某些網路環境下具有更大的優勢，但是 mKCP 有一個很明顯的缺點就是會比 TCP 耗費更多的流量，所以請酌情使用。要瞭解的一點是，mKCP 與 KCPTUN 同樣是 KCP 協定，但兩者並不相容。<br><a href="#KCP介紹">KCP</a> 後文會再作介紹</p>
<p>1.1. 配置<br>mKCP 的配置比較簡單，只需在伺服器的 inbound 和 客戶端的 outbound 添加一個 streamSettings 並設置成 mkcp 即可。</p>
<p>1.1.1. 伺服器配置</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">16823</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      "network": "mkcp", //此處的 mkcp 也可寫成 kcp，兩種寫法是起同樣的效果</div><div class="line">      "kcpSettings": &#123; //包含一些關於 mKCP 設置的參數</div><div class="line">        "mtu": 1350,</div><div class="line">        "tti": 20,</div><div class="line">        "uplinkCapacity": 5, //上行鏈路容量，將決定 V2Ray 向外發送資料包的速率。單位為 MB</div><div class="line">        "downlinkCapacity": 100,  //下行鏈路容量，將決定 V2Ray 接收資料包的速率。單位同樣是 MB</div><div class="line">        "congestion": false,</div><div class="line">        "readBufferSize": 1,</div><div class="line">        "writeBufferSize": 1,</div><div class="line">        "header": &#123; //對於資料包的偽裝</div><div class="line">          "type": "none" //要偽裝成的資料包類型， 可以設置成 utp、srtp、wechat-video 或者 none，這四個可以分別將 mKCP 資料偽裝成 BT 下載、視頻通話、微信視頻通話以及不進行偽裝。這裡的 type 參數，客戶端與伺服器要一致</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.2. 客戶端配置</p>
<figure class="highlight json"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"serveraddr.com"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">16823</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"mkcp"</span>,</div><div class="line">      <span class="attr">"kcpSettings"</span>: &#123;</div><div class="line">        <span class="attr">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">        <span class="attr">"tti"</span>: <span class="number">20</span>,</div><div class="line">        <span class="attr">"uplinkCapacity"</span>: <span class="number">5</span>,</div><div class="line">        <span class="attr">"downlinkCapacity"</span>: <span class="number">100</span>,</div><div class="line">        <span class="attr">"congestion"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">"readBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"writeBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"header"</span>: &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"none"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.3. 說明<br>在上面的配置當中，與之前相比主要的變化在於多了一個 streamSettings</p>
<p>客戶端的上行對於伺服器來說是下行，同樣地客戶端的下行是伺服器的上行，mKCP 設置當中伺服器和客戶端都有 uplinkCapacity 和 downlinkCapacity，所以客戶端的上傳速率由伺服器的 downlinkCapacity 和客戶端的 uplinkCapacity 中的最小值決定，客戶端的下載速率也是同樣的道理。因此，建議將伺服器和客戶端的 downlinkCapacity 設成一個很大的值，然後分別修改兩端的 uplinkCapacity 以調整上下行速率。</p>
<p>還有一個 header 參數可以對 mKCP 進行偽裝，這是 mKCP 的一個優勢。具體的偽裝在 type 參數設置，type 可以設置成 utp、srtp、wechat-video 或者 none，這四個可以分別將 mKCP 資料偽裝成 BT 下載、視頻通話、微信視頻通話以及不進行偽裝。這裡的 type 參數，客戶端與伺服器要一致</p>
<p>至於上述配置裡有但是我沒有說明的參數，是 V2Ray 的默認值，我個人建議是保持默認。如果你需要瞭解或者修改，請參考手冊。</p>
<hr>
<h3 id="動態端口"><a href="#動態端口" class="headerlink" title="動態端口"></a>動態端口</h3><p>V2Ray 提供了一個叫動態端口的功能。顧名思義，就是可以動態變化端口，對於對抗封鎖或許有效</p>
<p>伺服器 inbound 的端口作為主端口，在 inboundDetour 開動態監聽的端口，客戶端不用額外設定。</p>
<p>1.1.1. 伺服器配置</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>:&#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">37192</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"d17a1af7-efa5-42ca-b7e9-6a35282d737f"</span>,</div><div class="line">          <span class="attr">"level"</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"detour"</span>: &#123;        </div><div class="line">        <span class="attr">"to"</span>: <span class="string">"dynamicPort"</span>   </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inboundDetour"</span>:[</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">      "port": "10000-20000", // 端口範圍</div><div class="line">      "tag": "dynamicPort",       </div><div class="line">      "settings": &#123;</div><div class="line">        "default": &#123;</div><div class="line">          "level": 1,</div><div class="line">          "alterId": 32</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      "allocate": &#123;            // 分配模式</div><div class="line">        "strategy": "random",  // 隨機開啟</div><div class="line">        "concurrency": 2,      // 同時開放兩個端口</div><div class="line">        "refresh": 3           // 每三分鐘刷新一次</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></div></div></figure>
<hr>
<h3 id="動態端口使用-mKCP"><a href="#動態端口使用-mKCP" class="headerlink" title="動態端口使用 mKCP"></a>動態端口使用 mKCP</h3><p>同 mKCP 章節，在 inbound 和 inboundDetour 加入 streamSettings 並將 network 設置為 kcp 即可。<br>伺服器配置</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">37192</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"d17a1af7-efa5-42ca-b7e9-6a35282d737f"</span>,</div><div class="line">          <span class="attr">"level"</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="attr">"detour"</span>: &#123;        </div><div class="line">        <span class="attr">"to"</span>: <span class="string">"dynamicPort"</span>   </div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"kcp"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inboundDetour"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">      "port": "10000-20000", // 端口範圍</div><div class="line">      "tag": "dynamicPort",       </div><div class="line">      "settings": &#123;</div><div class="line">        "default": &#123;</div><div class="line">          "level": 1,</div><div class="line">          "alterId": 32</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      "allocate": &#123;            // 分配模式</div><div class="line">        "strategy": "random",  // 隨機開啟</div><div class="line">        "concurrency": 2,      // 同時開放兩個端口</div><div class="line">        "refresh": 3           // 每三分鐘刷新一次</div><div class="line">      &#125;,</div><div class="line">      "streamSettings": &#123;</div><div class="line">        "network": "kcp"</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></div></div></figure>
<hr>
<h3 id="傳出代理"><a href="#傳出代理" class="headerlink" title="傳出代理"></a>傳出代理</h3><p>V2Ray 提供了傳出代理功能，利用它可以實現中轉（在沒有中轉伺服器操作權限的情況下）。</p>
<p>1.1. 基本傳出代理<br>使用傳出代理可以實現由一個 Shadowsocks 伺服器或者 V2Ray(VMess) 伺服器來中轉你的網路流量，中轉伺服器只能看到你加密的資料而不知道原始的資料是什麼。</p>
<p>以下面的配置說明，它的工作原理是：</p>
<ol>
<li>你在 Twitter 發了個帖子 f**k GFW，由 V2Ray 代理</li>
<li>V2Ray 客戶端收到瀏覽器發出的 f**k GFW 的帖子後，首先由對其進行加密 (VMess，id: b12614c5-5ca4-4eba-a215-c61d642116ce, 目的伺服器: 1.1.1.1:8888)</li>
<li>加密後資料包將被轉到 transit 這個 outbound 中，在這裡資料包又會加密一次 (Shadowsocks, password: password, 伺服器: 2.2.2.2:1024)</li>
<li>兩次加密後的資料包被發送到了 Shadowsocks 伺服器，該伺服器收到後解包後得到仍是加密的資料包（步驟 2 中加密後的資料包），然後將資料包發到 VMess 伺服器。即便這個 Shadowsocks 伺服器的主人是個偷窺狂魔，他也沒辦法看到你的原始資料。</li>
<li>VMess 伺服器收到 Shadowsocks 伺服器發來的資料包，解密得到原始的資料包，然後把你這個帖子發到 Twitter 的網站中。</li>
</ol>
<p>只要第 5 步中的伺服器是自己掌控的就不用擔心別人看到你的上網的內容。</p>
<p>過程說明：<br>1.我是使用者-&gt;2.我是使用者安裝在系統上的 V2Ray 客戶端，加密成 V2Ray 格式→3.V2Ray 客戶端出口再加密成 SS 格式→4.中轉的 SS server 收到後只能解密一次，就再轉送給下一站→5.V2Ray Server 收到，解密後傳出。</p>
<p>客戶端：</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    "settings": &#123; // settings 的根據實際情況修改</div><div class="line">      "vnext": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"1.1.1.1"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">8888</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span>,</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b12614c5-5ca4-4eba-a215-c61d642116ce"</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "tcp"  // 此處不能是 "kcp"，設成 "kcp" 將無法聯網</div><div class="line">    &#125;,</div><div class="line">    "proxySettings": &#123;</div><div class="line">        "tag": "transit"  // 這裡的 tag 必須跟作為代理 VPS 的 tag 一致，這裡設定的是 "transit"</div><div class="line">      &#125;</div><div class="line">  &#125;,</div><div class="line">  "outboundDetour": [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"shadowsocks"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;</div><div class="line">        <span class="attr">"servers"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"address"</span>: <span class="string">"2.2.2.2"</span>,</div><div class="line">            <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</div><div class="line">            <span class="attr">"ota"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"password"</span>: <span class="string">"password"</span>,</div><div class="line">            <span class="attr">"port"</span>: <span class="number">1024</span></div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"transit"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.2. 鏈式傳出代理<br>如果你有多個 Shadowsocks 或 VMess 賬戶，那麼你可以這樣:</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    "settings": &#123; // settings 的根據實際情況修改</div><div class="line">      "vnext": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"1.1.1.1"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">8888</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span>,</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b12614c5-5ca4-4eba-a215-c61d642116ce"</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "tcp"</div><div class="line">    &#125;,</div><div class="line">    "tag": "DOUS",</div><div class="line">    "proxySettings": &#123;</div><div class="line">        "tag": "DOSG"</div><div class="line">      &#125;</div><div class="line">  &#125;,</div><div class="line">  "outboundDetour": [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"shadowsocks"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;</div><div class="line">        <span class="attr">"servers"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"address"</span>: <span class="string">"2.2.2.2"</span>,</div><div class="line">            <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</div><div class="line">            <span class="attr">"ota"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"password"</span>: <span class="string">"password"</span>,</div><div class="line">            <span class="attr">"port"</span>: <span class="number">1024</span></div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"AliHK"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"shadowsocks"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;</div><div class="line">        <span class="attr">"servers"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"address"</span>: <span class="string">"3.3.3.3"</span>,</div><div class="line">            <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</div><div class="line">            <span class="attr">"ota"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"password"</span>: <span class="string">"password"</span>,</div><div class="line">            <span class="attr">"port"</span>: <span class="number">3442</span></div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"AliSG"</span>,</div><div class="line">      <span class="attr">"proxySettings"</span>: &#123;</div><div class="line">          <span class="attr">"tag"</span>: <span class="string">"AliHK"</span></div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;</div><div class="line">        <span class="attr">"vnext"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"address"</span>: <span class="string">"4.4.4.4"</span>,</div><div class="line">            <span class="attr">"port"</span>: <span class="number">8462</span>,</div><div class="line">            <span class="attr">"users"</span>: [</div><div class="line">              &#123;</div><div class="line">                <span class="attr">"alterId"</span>: <span class="number">64</span>,</div><div class="line">                <span class="attr">"id"</span>: <span class="string">"b27c24ab-2b5a-433e-902c-33f1168a7902"</span></div><div class="line">              &#125;</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"DOSG"</span>,</div><div class="line">      <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">        <span class="attr">"network"</span>: <span class="string">"tcp"</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"proxySettings"</span>: &#123;</div><div class="line">          <span class="attr">"tag"</span>: <span class="string">"AliSG"</span></div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">  ]</div><div class="line">&#125;</div></pre></div></div></figure>
<p>那麼資料包經過的節點依次為： PC -&gt; AliHK -&gt; AliSG -&gt; DOSG -&gt; DOUS -&gt; 目標網站</p>
<p>這樣的傳出代理形成了一條鏈條，我稱之為鏈式傳出代理。</p>
<p>注意：如果你打算配置 (動態) 鏈式傳出代理，應當明確幾點：</p>
<ul>
<li>性能。鏈式代理使用了多個節點，可能會造成延時、帶寬等網路性能問題，並且客戶端對每一個加解密的次數取決於代理鏈的長度，理論上也會有一定的影響。</li>
<li>安全。前文提到，傳出代理會一定程度上提高安全性，但安全取決於最弱一環，並不意味著代理鏈越長就會越安全。如果你需要匿名，請考慮成熟的匿名方案。 另外，使用了傳出代理 streamSettings 會失效。</li>
</ul>
<hr>
<h3 id="HTTP-偽裝"><a href="#HTTP-偽裝" class="headerlink" title="HTTP 偽裝"></a>HTTP 偽裝</h3><p>（2018-03-16 註：個人建議不要使用 HTTP 偽裝） V2Ray 自 v2.5 版本開始提供 HTTP 偽裝功能，後經作者不斷完善，到現在已經非常成熟穩定了。V2Ray 的 HTTP 偽裝功能可以可以將 V2Ray 的流量偽裝成正常的 HTTP 協定的。這裡給出一個 HTTP 偽裝的伺服器端與客戶端配置文件示例。</p>
<p>配置中關於 HTTP 頭欄位的內容及含義，Wikipedia 有簡要的說明，可參閱。</p>
<p>1.1. 配置</p>
<p>從 V2Ray 的實現角度來說，使用 HTTP 偽裝的同時完全可以使用動態端口。但我個人並不建議這麼做，因為從實際情況來看，基本上不會有人在一個伺服器上開使用多個端口的 Web 服務。如果你覺得 HTTP 偽裝的配置過於複雜不懂得如何修改，那請直接使用下面的配置即可。</p>
<p>1.1.1. 伺服器</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"log"</span> : &#123;</div><div class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</div><div class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    "port": 80, //推薦80端口，更好地迷惑防火牆（好吧實際上並沒有什麼卵用</div><div class="line">    "protocol": "vmess",</div><div class="line">    "settings": &#123;</div><div class="line">      "clients": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">          <span class="attr">"level"</span>: <span class="number">1</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "tcp",</div><div class="line">      "tcpSettings": &#123;</div><div class="line">        "header": &#123; // header 這一項是關於資料包偽裝的設置，可自定義合理的內容，但要確保伺服器與客戶端一致</div><div class="line">          "type": "http",</div><div class="line">          "response": &#123;</div><div class="line">            "version": "1.1",</div><div class="line">            "status": "200",</div><div class="line">            "reason": "OK",</div><div class="line">            "headers": &#123;</div><div class="line">              "Content-Type": ["application/octet-stream", "application/x-msdownload", "text/html", "application/x-shockwave-flash"],</div><div class="line">              "Transfer-Encoding": ["chunked"],</div><div class="line">              "Connection": ["keep-alive"],</div><div class="line">              "Pragma": "no-cache"</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  "outboundDetour": [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"blocked"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  "routing": &#123;</div><div class="line">    "strategy": "rules",</div><div class="line">    "settings": &#123;</div><div class="line">      "rules": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [</div><div class="line">            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.2. 客戶端</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"log"</span>: &#123;</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"serveraddr.com"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">80</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"tcp"</span>,</div><div class="line">      <span class="attr">"tcpSettings"</span>: &#123;</div><div class="line">        "header": &#123;  //這裡的 header 要與伺服器保持一致</div><div class="line">          "type": "http",</div><div class="line">          "request": &#123;</div><div class="line">            "version": "1.1",</div><div class="line">            "method": "GET",</div><div class="line">            "path": ["/"],</div><div class="line">            "headers": &#123;</div><div class="line">              "Host": ["www.cloudflare.com", "www.amazon.com"],</div><div class="line">              "User-Agent": [</div><div class="line">                "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.75 Safari/537.36",</div><div class="line">                        <span class="string">"Mozilla/5.0 (iPhone; CPU iPhone OS 10_0_2 like Mac OS X) AppleWebKit/601.1 (KHTML, like Gecko) CriOS/53.0.2785.109 Mobile/14A456 Safari/601.1.46"</span></div><div class="line">              ],</div><div class="line">              "Accept-Encoding": ["gzip, deflate"],</div><div class="line">              "Connection": ["keep-alive"],</div><div class="line">              "Pragma": "no-cache"</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outboundDetour": [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"direct"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  "routing": &#123;</div><div class="line">    "strategy": "rules",</div><div class="line">    "settings": &#123;</div><div class="line">      "domainStrategy": "IPIfNonMatch",</div><div class="line">      "rules": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [</div><div class="line">            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"chinasites"</span>,</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"chinaip"</span>,</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<hr>
<h3 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h3><p>從 v1.19 起引入了 TLS，TLS 中文譯名是傳輸層安全，如果你沒聽說過，請 Google 瞭解一下。以下給出些我認為介紹較好的文章鏈結：</p>
<p><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" rel="external nofollow noopener noreferrer" target="_blank">SSL/TLS 協定運行機制的概述</a><br><a href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0" rel="external nofollow noopener noreferrer" target="_blank">傳輸層安全協定</a></p>
<h4 id="1-1-註冊一個域名"><a href="#1-1-註冊一個域名" class="headerlink" title="1.1. 註冊一個域名"></a>1.1. 註冊一個域名</h4><p>如果已經註冊有域名了可以跳過。 TLS 需要一個域名，域名有免費的和有付費的，如果你不捨得為一個域名每年花點錢，用個免費域名也可以，但總體來說付費的會優於免費的。為了方便，在本文中我就忽略如何註冊購買域名了。關於如何獲取域名，具體搜索相關文章教程。</p>
<p>註冊好域名之後務必記得添加一個 A 記錄指向你的 VPS!</p>
<p>以下假設註冊的域名為 mydomain.me，請將之替換成自己的域名。</p>
<h4 id="1-2-證書生成"><a href="#1-2-證書生成" class="headerlink" title="1.2. 證書生成"></a>1.2. 證書生成</h4><p>TLS 是證書認證機制，所以使用 TLS 需要證書，證書也有免費付費的，同樣的這裡使用免費證書，證書認證機構為 Let’s Encrypt。 證書的生成有許多方法，這裡使用的是比較簡單的方法：使用 acme.sh 腳本生成，本部分說明部分內容參考於 acme.sh README。</p>
<p>證書有兩種，一種是 ECC 證書（內置公鑰是 ECDSA 公鑰），一種是 RSA 證書（內置 RSA 公鑰）。簡單來說，同等長度 ECC 比 RSA 更安全, 也就是說在具有同樣安全性的情況下，ECC 的密鑰長度比 RSA 短得多（加密解密會更快）。但問題是 ECC 的相容性會差一些，Android 4.x 以下和 Windows XP 不支援。只要您的設備不是非常老的老古董，強烈建議使用 ECC 證書。</p>
<p>以下將給出這兩類證書的生成方法，請大家根據自身的情況自行選擇其中一種證書類型。</p>
<p>證書生成只需在伺服器上操作。</p>
<h5 id="1-2-1-安裝-acme-sh"><a href="#1-2-1-安裝-acme-sh" class="headerlink" title="1.2.1. 安裝 acme.sh"></a>1.2.1. 安裝 acme.sh</h5><p>安裝 EPEL 軟體擴充資源庫：</p>
<pre><code>yum install epel-release
</code></pre><p>Let’s Encrypt 憑證取得方式不同與其他網站是在網頁上手動填寫申請資料的，而是須在 Server 上安裝一個 Client（python 寫的），這種作法所帶來的好處是可全自動化，這裡使用 Let’s Encrypt 官方推薦的 Certbot Client，來自動取得、部署和更新 SSL 憑證：</p>
<pre><code>yum install certbot
</code></pre><p>執行以下命令，acme.sh 會安裝到 ~/.acme.sh 目錄下。</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></div><div class="code"><pre><div class="line">$ curl  https://get.acme.sh | sh</div><div class="line">% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                               Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100   671  100   671    0     0    680      0 --:--:-- --:--:-- --:--:--   679</div><div class="line">% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                               Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100  112k  100  112k    0     0   690k      0 --:--:-- --:--:-- --:--:--  693k</div><div class="line">[Fri 30 Dec 01:03:32 GMT 2016] Installing from online archive.</div><div class="line">[Fri 30 Dec 01:03:32 GMT 2016] Downloading https://github.com/Neilpang/acme.sh/archive/master.tar.gz</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Extracting master.tar.gz</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Installing to /home/user/.acme.sh</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Installed to /home/user/.acme.sh/acme.sh</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Installing <span class="built_in">alias</span> to <span class="string">'/home/user/.profile'</span></div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] OK, Close and reopen your terminal to start using acme.sh</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Installing cron job</div><div class="line">no crontab <span class="keyword">for</span> user</div><div class="line">no crontab <span class="keyword">for</span> user</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Good, bash is found, so change the shebang to use bash as preferred.</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] OK</div><div class="line">[Fri 30 Dec 01:03:33 GMT 2016] Install success!</div></pre></div></div></figure>
<p>安裝成功後執行 <code>source ~/.bashrc</code> 以確保腳本所設置的命令別名生效。</p>
<p>如果安裝報錯，那麼可能是因為系統缺少 acme.sh 所需要的依賴項，acme.sh 的依賴項主要是 netcat(nc)，我們通過以下命令來安裝這些依賴項，然後重新安裝一遍 acme.sh:</p>
<pre><code>sudo apt-get -y install netcat
</code></pre><h5 id="1-2-2-使用-acme-sh-生成證書"><a href="#1-2-2-使用-acme-sh-生成證書" class="headerlink" title="1.2.2. 使用 acme.sh 生成證書"></a>1.2.2. 使用 acme.sh 生成證書</h5><p>證書生成<br>執行以下命令生成證書：</p>
<p>以下的命令會臨時監聽 80 端口，請確保執行該命令前 80 端口沒有使用</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></div><div class="code"><pre><div class="line">$ sudo ~/.acme.sh/acme.sh --issue -d mydomain.me --standalone -k ec-256</div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] Standalone mode.</div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] Single domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] Getting domain auth token <span class="keyword">for</span> each domain</div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] Getting webroot <span class="keyword">for</span> domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] _w=<span class="string">'no'</span></div><div class="line">[Fri Dec 30 08:59:12 HKT 2016] Getting new-authz <span class="keyword">for</span> domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec 30 08:59:14 HKT 2016] The new-authz request is ok.</div><div class="line">[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip.</div><div class="line">[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip http-01.</div><div class="line">[Fri Dec 30 08:59:14 HKT 2016] mydomain.me is already verified, skip http-01.</div><div class="line">[Fri Dec 30 08:59:14 HKT 2016] Verify finished, start to sign.</div><div class="line">[Fri Dec 30 08:59:16 HKT 2016] Cert success.</div><div class="line">-----BEGIN CERTIFICATE-----</div><div class="line">MIIEMTCCAxmgAwIBAgISA1+gJF5zwUDjNX/6Xzz5fo3lMA0GCSqGSIb3DQEBCwUA</div><div class="line">MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD</div><div class="line">ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xNjEyMjkyMzU5MDBaFw0x</div><div class="line">NzAzMjkyMzU5MDBaMBcxFTATBgNVBAMTDHdlYWtzYW5kLmNvbTBZMBMGByqGSM49</div><div class="line">****************************************************************</div><div class="line">4p40tm0aMB837XQ9jeAXvXulhVH/7/wWZ8/vkUUvuHSCYHagENiq/3DYj4a85Iw9</div><div class="line">+6u1r7atYHJ2VwqSamiyTGDQuhc5wdXIQxY/YQQqkAmn5tLsTZnnOavc4plANT40</div><div class="line">zweiG8vcIvMVnnkM0TSz8G1yzv1nOkruN3ozQkLMu6YS7lk/ENBN7DBtYVSmJeU2</div><div class="line">VAXE+zgRaP7JFOqK6DrOwhyE2LSgae83Wq/XgXxjfIo1Zmn2UmlE0sbdNKBasnf9</div><div class="line">gPUI45eltrjcv8FCSTOUcT7PWCa3</div><div class="line">-----END CERTIFICATE-----</div><div class="line">[Fri Dec 30 08:59:16 HKT 2016] Your cert is <span class="keyword">in</span>  /root/.acme.sh/mydomain.me_ecc/mydomain.me.cer</div><div class="line">[Fri Dec 30 08:59:16 HKT 2016] Your cert key is <span class="keyword">in</span>  /root/.acme.sh/mydomain.me_ecc/mydomain.me.key</div><div class="line">[Fri Dec 30 08:59:16 HKT 2016] The intermediate CA cert is <span class="keyword">in</span>  /root/.acme.sh/mydomain.me_ecc/ca.cer</div><div class="line">[Fri Dec 30 08:59:16 HKT 2016] And the full chain certs is there:  /root/.acme.sh/mydomain.me_ecc/fullchain.cer</div></pre></div></div></figure>
<p><code>-k</code> 表示密鑰長度，後面的值可以是 <code>ec-256 、ec-384、2048、3072、4096、8192</code>，帶有 <code>ec</code> 表示生成的是 ECC 證書，沒有則是 RSA 證書。在安全性上 256 位的 ECC 證書等同於 3072 位的 RSA 證書。</p>
<h5 id="證書更新"><a href="#證書更新" class="headerlink" title="證書更新"></a>證書更新</h5><p>由於 Let’s Encrypt 的證書有效期只有 3 個月，因此需要 90 天至少要更新一次證書，acme.sh 腳本會每 60 天自動更新證書。也可以手動更新。</p>
<p>手動更新 ECC 證書，執行：</p>
<pre><code>sudo ~/.acme.sh/acme.sh --renew -d mydomain.com --force --ecc
</code></pre><p>如果是 RSA 證書則執行：</p>
<pre><code>sudo ~/.acme.sh/acme.sh --renew -d mydomain.com --force
</code></pre><p>由於本例中將證書生成到 /etc/v2ray/ 文件夾，更新證書之後還得把新證書生成到 /etc/v2ray。</p>
<h5 id="1-2-3-安裝證書和密鑰"><a href="#1-2-3-安裝證書和密鑰" class="headerlink" title="1.2.3. 安裝證書和密鑰"></a>1.2.3. 安裝證書和密鑰</h5><p>ECC 證書<br>將證書和密鑰安裝到 /etc/v2ray 中：</p>
<pre><code>sudo ~/.acme.sh/acme.sh --installcert -d mydomain.me --fullchainpath /etc/v2ray/v2ray.crt --keypath /etc/v2ray/v2ray.key --ecc
</code></pre><p>RSA 證書</p>
<pre><code>sudo ~/.acme.sh/acme.sh --installcert -d mydomain.me --fullchainpath /etc/v2ray/v2ray.crt --keypath /etc/v2ray/v2ray.key
</code></pre><p>注意：無論什麼情況，密鑰 (即上面的 v2ray.key) 都不能洩漏，如果你不幸洩漏了密鑰，可以使用 acme.sh 將原證書吊銷，再生成新的證書，吊銷方法請自行參考 acme.sh 的手冊</p>
<h4 id="1-3-配置-V2Ray"><a href="#1-3-配置-V2Ray" class="headerlink" title="1.3. 配置 V2Ray"></a>1.3. 配置 V2Ray</h4><p>1.3.1. 伺服器</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    "port": 443, // 建議使用 443 端口</div><div class="line">    "protocol": "vmess",    </div><div class="line">    "settings": &#123;</div><div class="line">      "clients": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"23ad6b10-8d1a-40f7-8ad0-e3e35cd38297"</span>,  </div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "tcp",</div><div class="line">      "security": "tls", // security 要設置為 tls 才會啟用 TLS</div><div class="line">      "tlsSettings": &#123;</div><div class="line">        "certificates": [</div><div class="line">          &#123;</div><div class="line">            "certificateFile": "/etc/v2ray/v2ray.crt", // 證書文件</div><div class="line">            "keyFile": "/etc/v2ray/v2ray.key" // 密鑰文件</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.3.2. 客戶端</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          "address": "mydomain.me", // tls 需要域名，所以這裡應該填自己的域名</div><div class="line">          "port": 443,</div><div class="line">          "users": [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"23ad6b10-8d1a-40f7-8ad0-e3e35cd38297"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "tcp",</div><div class="line">      "security": "tls" // 客戶端的 security 也要設置為 tls</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<h4 id="1-4-驗證"><a href="#1-4-驗證" class="headerlink" title="1.4. 驗證"></a>1.4. 驗證</h4><p>一般來說，按照以上步驟操作完成，V2Ray 客戶端能夠正常聯網說明 TLS 已經成功啟用。但要是有個可靠的方法來驗證是否正常開啟 TLS 無疑更令人放心。 驗證的方法有很多，我僅介紹一種小白化一點的，便是 Qualys SSL Labs’s SSL Server Test。</p>
<p>注意：使用 Qualys SSL Labs’s SSL Server Test 要求使用 443 端口，意味著你伺服器配置的 inbound.port 應當是 443</p>
<p>打開 Qualys SSL Labs’s SSL Server Test，在 Hostname 中輸入你的域名，點提交，過一會結果就出來了。</p>
<hr>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>WebSocket 的配置其實很簡單，就跟 mKCP 一樣把 network 一改就行了。話不多說，直接上配置。</p>
<p>1.1. 配置<br>1.1.1. 伺服器配置<br><figure class="highlight json"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">16823</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>:<span class="string">"ws"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<p>1.1.2. 客戶端配置</p>
<figure class="highlight json"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"serveraddr.com"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">16823</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>:&#123;</div><div class="line">      <span class="attr">"network"</span>:<span class="string">"ws"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<hr>
<h3 id="WebSocket-TLS-Web"><a href="#WebSocket-TLS-Web" class="headerlink" title="WebSocket+TLS+Web"></a>WebSocket+TLS+Web</h3><p>前文分別提到過 TLS 和 WebSocket 的配置方法，而本文搭配 Web 服務並同時實現 TLS 和 WebSocket。關於 Web 的軟件本文給出了 Nginx 和 Caddy 兩個例子，二選一即可，也可以選用其他的軟件（如 Apache）。</p>
<p>很多新手一接觸 V2Ray 就想搞 WebSocket+TLS+Web 或 WebSocket+TLS+Web+CDN，我就想問 ssh 和 vim/nano 用利索了沒，步子這麼大不怕扯到蛋嗎？使用 Nginx/Caddy 是因為 VPS 已經有 Nginx/Caddy 可以將 V2Ray 稍作隱藏，使用 WebSocket 是因為搭配 Nginx/Caddy 只能用 WebSocket，使用 TLS 是因為可以流量加密，看起來更像 HTTPS。 也許 WebSocket+TLS+Web 的配置組合相對較好，但不意味著這樣的配置適合任何人。因為本節涉及 Nginx 和 Caddy，只給出了配置示例而不講具體使用方法，也就是說你在閱讀本節內容前得會使用這兩個軟件的其中之一，如果你還不會，請自行 Google。</p>
<p>注意: V2Ray 的 Websocket+TLS 配置組合並不依賴 Nginx 或 Caddy，只是能與其搭配使用而已，沒有它們也可以正常使用。</p>
<p>1.1. 配置<br>這次 TLS 的配置將寫入 Nginx 或者 Caddy 配置中，由這些軟件來監聽 443 端口，然後將其轉發到 V2Ray 的 WebSocket 所監聽的內網端口，V2Ray 伺服器端不需要配置 TLS。</p>
<p>1.1.1. 伺服器配置</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">10000</span>,</div><div class="line">    "listen":"127.0.0.1",//只監聽 127.0.0.1，避免除本機外的機器探測到開放了 10000 端口</div><div class="line">    "protocol": "vmess",</div><div class="line">    "settings": &#123;</div><div class="line">      "clients": [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    "streamSettings": &#123;</div><div class="line">      "network": "ws",</div><div class="line">      "wsSettings": &#123;</div><div class="line">      "path": "/ray"</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.2. Nginx 配置<br>配置中使用的是域名和證書使用 TLS 小節的舉例，請替換成自己的。</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></div><div class="code"><pre><div class="line">server &#123;</div><div class="line">  listen  443 ssl;</div><div class="line">  ssl on;</div><div class="line">  ssl_certificate       /etc/v2ray/v2ray.crt;</div><div class="line">  ssl_certificate_key   /etc/v2ray/v2ray.key;</div><div class="line">  ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">  ssl_ciphers           HIGH:!aNULL:!MD5;</div><div class="line">  server_name           mydomain.me;</div><div class="line">        location /ray &#123;</div><div class="line">        proxy_redirect off;</div><div class="line">        proxy_pass http://127.0.0.1:10000;#假設WebSocket監聽在環回位址的10000端口上</div><div class="line">        proxy_http_version 1.1;</div><div class="line">        proxy_set_header Upgrade $http_upgrade;</div><div class="line">        proxy_set_header Connection "upgrade";</div><div class="line">        proxy_set_header Host $http_host;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.3. Caddy 配置<br>因為 Caddy 會自動申請證書並自動更新，所以使用 Caddy 不用指定證書、密鑰。</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></div><div class="code"><pre><div class="line">mydomain.me</div><div class="line">&#123;</div><div class="line">  log ./caddy.log</div><div class="line">  proxy /ray localhost:10000 &#123;</div><div class="line">    websocket</div><div class="line">    header_upstream -Origin</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.4. 客戶端配置</p>
<figure class="highlight json"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span>,</div><div class="line">      <span class="attr">"udp"</span>: <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"mydomain.me"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"ws"</span>,</div><div class="line">      <span class="attr">"security"</span>: <span class="string">"tls"</span>,</div><div class="line">      <span class="attr">"wsSettings"</span>: &#123;</div><div class="line">        <span class="attr">"path"</span>: <span class="string">"/ray"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.5. 注意事項</p>
<ul>
<li>較低版本的 nginx 的 location 需要寫為 <code>/ray/</code> 才能正常工作</li>
<li>如果在設置完成之後不能成功使用，可能是由於 SElinux 機制 (如果你是 CentOS 7 的用戶請特別留意 SElinux 這一機制) 阻止了 Nginx 轉發向內網的資料。如果是這樣的話，在 V2Ray 的日誌裡不會有訪問資訊，在 Nginx 的日誌裡會出現大量的 “Permission Denied” 欄位，要解決這一問題需要在終端下鍵入以下命令：<br>  setsebool -P httpd_can_network_connect 1</li>
<li>請保持伺服器和客戶端的 wsSettings 嚴格一致，對於 V2Ray，/ray 和 /ray/ 是不一樣的</li>
</ul>
<p>1.1.6. 其他的話</p>
<ol>
<li>開啟了 TLS 之後 path 參數是被加密的，GFW 看不到；</li>
<li>主動探測一個 path 產生 Bad request 不能證明是 V2Ray；</li>
<li>不安全的因素在於人，自己的問題就不要甩鍋，哪怕我把示例中的 path 改成一個 UUID，依然有不少人原封不動地 COPY；</li>
<li>使用 Header 分流並不比 path 安全， 不要迷信。</li>
</ol>
<hr>
<h3 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP/2"></a>HTTP/2</h3><p>簡單地說 HTTP/2 是 HTTP/1.1 的升級版（目前大多數網頁還是 HTTP/1.1），點擊這裡可以直觀地體會到 HTTP/2 相比於 HTTP/1.1 的提升（不代表 V2Ray 中 HTTP/2 相對於 TCP 的提升就是這樣的）。</p>
<p>在 V2Ray 的手冊中並沒有 HTTP/2 的相關內容，而且 V2Ray 的 HTTP/2 還處於測試階段。</p>
<p>1.1. 配置<br>最近幾版的 V2Ray 已經開始支援 HTTP/2，可能 v3.12 就支援了，實測 v3.14 能夠使用 HTTP/2 了。與其他的傳輸層協定一樣在 streamSettings 中配置。</p>
<p>1.1.1. 伺服器配置</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">443</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      "network": "h2", // h2 也可寫成 http，效果一樣</div><div class="line">      "httpSettings": &#123; //此項是關於 HTTP/2 的設置</div><div class="line">        "path": "/ray"</div><div class="line">      &#125;,</div><div class="line">      "security": "tls", // 配置tls</div><div class="line">      "tlsSettings": &#123;</div><div class="line">        "certificates": [</div><div class="line">          &#123;</div><div class="line">            "certificateFile": "/etc/v2ray/v2ray.crt", // 證書文件，詳見 tls 小節</div><div class="line">            "keyFile": "/etc/v2ray/v2ray.key" // 密鑰文件</div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "outbound": &#123;</div><div class="line">    "protocol": "freedom",</div><div class="line">    "settings": &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>1.1.2. 客戶端配置<br><figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span>,</div><div class="line">      <span class="attr">"udp"</span>: <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"address"</span>: <span class="string">"mydomain.me"</span>,</div><div class="line">          <span class="attr">"port"</span>: <span class="number">443</span>,</div><div class="line">          <span class="attr">"users"</span>: [</div><div class="line">            &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"b831381d-6324-4d53-ad4f-8cda48b30811"</span>,</div><div class="line">              <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">            &#125;</div><div class="line">          ]</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"h2"</span>,</div><div class="line">      "httpSettings": &#123; //此項是關於 HTTP/2 的設置</div><div class="line">        "path": "/ray"</div><div class="line">      &#125;,</div><div class="line">      "security": "tls"</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure></p>
<hr>
<h3 id="不推薦的配置"><a href="#不推薦的配置" class="headerlink" title="不推薦的配置"></a>不推薦的配置</h3><p>也許有一部分朋友發現了，高級篇的內容關於傳輸層的，各種配置的組合，可以搭配出非常多的配置。但是，有一些組合是我認為不值得或者是冗餘的（僅代表個人意見），以下給出。</p>
<ul>
<li><p>TLS+KCP<br>這是相當一部分人喜歡的組合，不推薦的原因是 vmess 本身的加密方式已經足夠，加 TLS 只是多消耗設備算力，尤其是移動設備，TLS 也不在最外層，已經失去大部分人使用 TLS 的初衷。</p>
</li>
<li><p>TLS+HTTP 偽裝<br>這並沒有什麼卵用，這樣的組合不是 HTTPS。</p>
</li>
<li><p>單純使用 Websocket<br>理論上，使用 Websocket 會比 TCP 性能差一些，所以如果不是搭配 CDN、nginx 或者在 PaaS 上使用，那還是使用 TCP 吧。</p>
</li>
</ul>
<hr>
<h3 id="透明代理"><a href="#透明代理" class="headerlink" title="透明代理"></a>透明代理</h3><p>透明代理是什麼意思請自行 Google，在這兒指使用 V2Ray 做透明代理實現路由器翻牆。然而，我個人認為路由器翻牆的說法並不準確，應該叫閘道翻牆。所以本例實際上是關於閘道翻牆的內容。當然了，單純使用路由器翻牆也是可以的，因為普通的家用路由器本就是一個閘道。使用閘道翻牆可以使局域網內的所有設備都具有直接翻牆的能力，並且能夠全局代理，而不必每台設備都安裝 V2Ray，配置更新時只需在閘道修改配置，用一些網友的話說就是就感覺沒有牆一樣。但是，有意上透明代理的同學請評估一下透明代理是否合適自己，而不要盲目跟風。</p>
<p>透明代理適用於以下情況：</p>
<ul>
<li>局域網設備較多，比如說辦公室、實驗室、子孫滿堂的家庭等；</li>
<li>設備 (的軟件) 無法 / 不方便設置代理，比如說 chromecast、電視盒子等；</li>
<li><p>希望設備的所有軟件都走代理。<br>不適用於：</p>
</li>
<li><p>隨便拿個垃圾路由器就想上的</p>
</li>
</ul>
<p>1.1. 優點<br>其實，V2Ray 早就可以作透明代理，當時我也研究了好一段時間，最終是折騰出來了。但是由於 DNS 的問題，我用著總感覺不太舒服。雖然有 ChinaDNS 這類的解決方案，但個人主觀上並不喜歡。 不過嘛，現在就不一樣了。就目前來說，使用 V2Ray 透明代理：</p>
<ol>
<li>解決了牆外 DNS 污染問題；</li>
<li>在解決了 1 的情況下國內域名的即能夠解析到國內 CDN；</li>
<li>不需要外部軟件或自建 DNS 就可決絕 1 和 2 的問題，只要系統支援 V2Ray 和 iptables；</li>
<li>能夠完美利用 V2Ray 強大而靈活的路由功能，而不必額外維護一個路由表；</li>
</ol>
<p>1.2. 軟硬體準備</p>
<ul>
<li>一台已經搭建 V2Ray 並能正常使用的 VPS ，本文假設 IP 為 110.231.43.65；</li>
<li>一台帶 iptables、有 root 權限並且系統為 Linux 的設備，假設位址為 192.168.1.22，已經配置好 V2Ray 作為客戶端。這個設備可以是路由器、開發板、個人電腦、虛擬機和 Android 設備等，更具普適性地稱之為閘道。我個人非常不建議使用 MT7620 系路由器開透明代理，性能太差了，很多固件也沒有開啟 FPU 。要是真不願意出這點錢，用電腦開個虛擬機吧 (我就是這麼幹的)，VirtualBox、Hyper 之類的都可以，但是別忘了網路模式用網橋。</li>
</ul>
<p>1.3. 設置步驟</p>
<p>設置步驟如下，假設使用 root。</p>
<ol>
<li><p>閘道開啟 IP 轉發。在 /etc/sysctl.conf 文件添加一行 net.ipv4.ip_forward=1 ，執行下列命令生效：<br> sysctl -p</p>
</li>
<li><p>路由器 DHCP 設定閘道位址為閘道設備的 IP，本例為 192.168.1.22，或者電腦手機等設備單獨設置閘道位址，但閘道設備必須指定閘道位址為路由器的 IP，然後電腦 / 手機測試是不是可以正常上網 (這時還不能翻牆)，如果不能上網先去學習一個把這個搞定，否則接下來再怎麼也同樣上不了網。</p>
</li>
<li><p>在伺服器和閘道安裝 V2Ray（如果不會就參照前面的教程，由於 GFW 會惡化 GitHub Releases 的流量，閘道直接運行腳本幾乎無法安裝，建議從 <a href="https://v2ray.com/download" rel="external nofollow noopener noreferrer" target="_blank">https://v2ray.com/download</a> 下載然後使用 –local 參數進行安裝），並配置好配置文件。一定要確定搭建的 V2Ray 能夠正常使用。在閘道執行 <code>curl -x socks5://127.0.0.1:1080 google.com</code>測試配置的 V2Ray 是否可以翻牆 (命令中 socks5 指 inbound 為 socks，1080 指該 inbound 端口是 1080)。如果出現類似下面的輸出則可以翻牆，如果沒有出現就說明翻不了，你得仔細檢查以下哪步操作不對或漏了。</p>
</li>
</ol>
<figure class="highlight html"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></div><div class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span><span class="tag">&lt;<span class="name">HEAD</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"content-type"</span> <span class="attr">content</span>=<span class="string">"text/html;charset=utf-8"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">TITLE</span>&gt;</span>301 Moved<span class="tag">&lt;/<span class="name">TITLE</span>&gt;</span><span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span><span class="tag">&lt;<span class="name">BODY</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">H1</span>&gt;</span>301 Moved<span class="tag">&lt;/<span class="name">H1</span>&gt;</span></div><div class="line">The document has moved</div><div class="line"><span class="tag">&lt;<span class="name">A</span> <span class="attr">HREF</span>=<span class="string">"http://www.google.com/"</span>&gt;</span>here<span class="tag">&lt;/<span class="name">A</span>&gt;</span>.</div><div class="line"><span class="tag">&lt;/<span class="name">BODY</span>&gt;</span><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></div></pre></div></div></figure>
<p>在閘道的配置，添加 dokodemo ，並開啟 domain override（注意不要寫錯配置）。配置形如：</p>
<figure class="highlight"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line"> "inbound": &#123;...&#125;,</div><div class="line"> "outbound": &#123;...&#125;,</div><div class="line"> "inboundDetour": [</div><div class="line">     &#123;</div><div class="line">         <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">         <span class="attr">"port"</span>: <span class="number">12345</span>,</div><div class="line">         <span class="attr">"protocol"</span>: <span class="string">"dokodemo-door"</span>,</div><div class="line">         <span class="attr">"settings"</span>: &#123;</div><div class="line">             <span class="attr">"network"</span>: <span class="string">"tcp,udp"</span>,</div><div class="line">             <span class="attr">"followRedirect"</span>: <span class="literal">true</span></div><div class="line">         &#125;</div><div class="line">     &#125;,</div><div class="line">     ...</div><div class="line"> ],</div><div class="line"> "outboundDetour": [...],</div><div class="line"> "routing": &#123;...&#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>設定 iptables 規則，命令如下</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></div><div class="code"><pre><div class="line">iptables -t nat -N V2RAY</div><div class="line">iptables -t nat -A V2RAY -d 192.168.0.0/16 -j RETURN</div><div class="line">iptables -t nat -A V2RAY -p tcp -j REDIRECT --to-ports 12345</div><div class="line">iptables -t nat -A PREROUTING -p tcp -j V2RAY</div></pre></div></div></figure>
<p>UDP 流量透明代理的 iptables 規則，命令如下</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></div><div class="code"><pre><div class="line">ip rule add fwmark 1 table 100</div><div class="line">ip route add <span class="built_in">local</span> 0.0.0.0/0 dev lo table 100</div><div class="line">iptables -t mangle -N V2RAY_MASK</div><div class="line">iptables -t mangle -A V2RAY_MASK  -d 192.168.0.0/16 -j RETURN</div><div class="line">iptables -t mangle -A V2RAY_MASK -p udp -j TPROXY --on-port 12345 --tproxy-mark 1</div><div class="line">iptables -t mangle -A PREROUTING -p udp -j V2RAY_MASK</div></pre></div></div></figure>
<ol>
<li><p>使用電腦 / 手機直接訪問被牆網站，這時應當可以訪問的（如果不能，你可能得請教大神手把手指導了）。</p>
</li>
<li><p>寫腳本開機載入上述的 iptables，或者使用第三方軟件 (如 iptables-persistent)，否則閘道重啟後 iptables 會失效 (即透明代理會失效)。</p>
</li>
</ol>
<p>1.4. 注意事項</p>
<ul>
<li>在上面的設置中，假設訪問了國外網站，如 Google 等，閘道依然會使用的系統 DNS 進行查詢，只不過返回的結果是污染過的，而 V2Ray 提供的 domain override 能夠從流量中提取域名資訊交由 VPS 解析。也就是說，每次打算訪問被牆的網站，DNS 提供商都知道，鑑於國內企業尿性，也許 GFW 也都知道，會不會將這些資料收集喂 AI 也未可知。解決辦法是建一個 DNS，不向上級查詢，直接返回一個錯誤的 IP，反正 V2Ray 能夠解決污染問題。如果有朋友知道有什麼這樣的軟件，請告之 (可以使用 dnsmasq 實現)。</li>
<li>domain override 目前只能從 TLS 和 HTTP 流量中提取域名，如果上網流量有非這兩種類型的慎用 domain override 解決 DNS 污染。</li>
<li>由於對 iptables 不熟，我省略掉了對 UDP 流量的透明代理的設置，請精通此道的朋友補充一下 (目前 V2Ray 對 UDP 透明代理的實現有些問題，網路流量有大量 UDP 的網友請慎用)。</li>
<li>V2Ray 只能代理 TCP/UDP 的流量，ICMP 不支援，即就算透明代理成功了之後 ping Google 這類網站也是不通的。</li>
<li>最好設定閘道的位址為靜態 IP，否則閘道重啟後換了 IP 上不了網會很尷尬</li>
<li>上述的 iptables 配置只能使局域網內的其他設備翻牆，閘道本身是無法翻牆的，如果要閘道也能翻牆，要使用 iptables 的 owener 模組直連 V2Ray 發出的流量，然後執行 iptables -t nat -A OUTPUT -p tcp -j V2RAY。</li>
<li>按照網上的透明代理教程，設置 iptables 肯定要 RETURN 127.0.0.0/8 這類私有位址，但我個人觀點是放到 V2Ray 的路由裡好一些。</li>
</ul>
<hr>
<h2 id="Docker-部署-V2Ray"><a href="#Docker-部署-V2Ray" class="headerlink" title="Docker 部署 V2Ray"></a>Docker 部署 V2Ray</h2><p>Docker 技術是一種新的虛擬化技術，和傳統的虛擬化技術不同。V2Ray 同樣提供 Docker 部署方式，並且通過 Docker 來部署 V2Ray 會非常輕鬆高效。</p>
<p>Docker 只能部署在 KVM 或者 XEN 架構的 VPS 中</p>
<p>首先安裝 Docker：</p>
<pre><code>sudo apt-get install -y docker
</code></pre><p>安裝完 Docker 後我們從 <a href="https://toutyrater.github.io/app/https%EF%BC%9A/hub.docker.com" rel="external nofollow noopener noreferrer" target="_blank">DockerHub</a> 通過搜索找到 V2Ray 官方提供的鏡像， <a href="https://toutyrater.github.io/app/https%EF%BC%9A/hub.docker.com/r/v2ray/official" rel="external nofollow noopener noreferrer" target="_blank">鏈結</a>在此. 找到拉取鏡像的的命令並複製下來，在網頁右側我們可以看到命令為 docker pull v2ray/official ，我們將其複製下來回到命令行中粘貼並執行：</p>
<pre><code>sudo docker pull v2ray/official
</code></pre><p>待 V2Ray 的 Docker 鏡像拉取完成後就可以進入下一個部署階段. 在此之前，你需要在 /etc 目錄下新建一個文件夾 v2ray， 並把你的配置寫好後命名為 config.json 放入 v2ray 文件夾內. 待配置文件準備就緒後鍵入以下命令進行部署，部署前請記下配置文件中你所設置的端口號，在部署時需要將其映射到宿主機上. 否則將無法訪問. 此處假設設定的端口號為 8888，需要映射到宿主機的 8888 端口上. 則命令為：</p>
<pre><code>sudo docker run -d --name v2ray -v /etc/v2ray：/etc/v2ray -p 8888:8888 v2ray/official  v2ray -config=/etc/v2ray/config.json
</code></pre><p>鍵入以上命令後，命令行會出現一串字符，代表容器部署成功，可以立即通過客戶端連接並開始使用了. 如果還不放心，鍵入以下命令來查看容器的運行狀態：</p>
<pre><code>sudo docker container ls
</code></pre><p>如果看到輸出的結果中有以下欄位代表容器成功運行：</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></div><div class="code"><pre><div class="line">$ docker container ls</div><div class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                     NAMES</div><div class="line">2a7sdo87kdf3        v2ray/official        <span class="string">"v2ray -config=/et..."</span>   3 minutes ago       Up 3 minutes        0.0.0.0：8888-&gt;8888/tcp    v2ray</div></pre></div></div></figure>
<p>通過以下命令來啟動 V2Ray：</p>
<pre><code>sudo docker container start v2ray
</code></pre><p>停止 V2Ray：</p>
<pre><code>sudo docker container stop v2ray
</code></pre><p>重啟 V2Ray：</p>
<pre><code>sudo docker container restart v2ray
</code></pre><p>查看日誌：</p>
<pre><code>sudo docker container log  v2ray
</code></pre><p>更新配置後，需要重新部署容器，命令如下：</p>
<pre><code>sudo docker container stop v2ray
sudo docker container rm v2ray
sudo docker run -d --name v2ray -v /etc/v2ray：/etc/v2ray -p 8888：8888 v2ray/official  v2ray -config=/etc/v2ray/config.json
</code></pre><p>假如你的配置換了端口號，那麼相應的端口映射也要更改，假如你在配置文件中把監聽端口改為了 9999，則’-p’參數應該這樣寫：</p>
<pre><code>-p  9999:9999
</code></pre><p>假如你想將容器中的端口映射到本機的端口，則命令應該這樣寫</p>
<pre><code>-p 127.0.0.1:端口號:端口號
</code></pre><p>除非你打算使用 Nginx 來轉發 Websocket 否則不需要映射到本地，直接填寫端口號：端口號的形式即可</p>
<p>另外，如果開啟了動態端口，-p 標記可以多次使用來綁定多個端口. 具體用法是在指令中再加上多個 -p 標記即可。</p>
<p>更新 V2Ray 的 Docker 鏡像：</p>
<pre><code>docker pull v2ray/official
</code></pre><p>更新完之後，你需要重新部署容器，方法見上。</p>
<hr>
<h2 id="BBR"><a href="#BBR" class="headerlink" title="BBR"></a>BBR</h2><p>需注意此方法無法和 WebSock 轉發併用</p>
<p>作者<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup><br>網上限定說記憶體需要 1G 大小，最小也需要 128M，經過我的折騰發現，128M 小記憶體 VPS 有時候並不如意，即使安裝好了 UML 也進不去系統，這就很讓人捉急，但是還好有了 LKL，比 UML 更加的方便，今天的教程就是教大家使用小記憶體 VPS 安裝 LKL+v2ray 體驗極速上網。</p>
<p>開始<br>首先還是一點，你需要 VPS，本次教程環境是 openvz，如果你沒有，那就可以去買個 KVM 框架的 VPS，免去折騰<br>推薦 BBR <a href="https://www.aihoom.com/842.html" rel="external nofollow noopener noreferrer" target="_blank">一鍵安裝</a> + <a href="https://www.aihoom.com/1193.html" rel="external nofollow noopener noreferrer" target="_blank">小白翻牆教程</a><br>服務搭建已經寫在教程中。</p>
<p>本次教程環境<br>debian8 mini</p>
<p>128M 記憶體 + 20 端口轉發 NET</p>
<p>連接 SSH<br>Windows 推薦使用 putty 或者 Xshell，這裡不多贅述。</p>
<p>安裝 LKL<br>wget –no-check-certificate <a href="https://github.com/91yun/uml/raw/master/lkl/install.sh" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/91yun/uml/raw/master/lkl/install.sh</a> &amp;&amp; bash install.sh</p>
<p>判斷是否安裝成功</p>
<p>ping 10.0.0.2 如果能 ping 通就說明安裝成功，否則失敗</p>
<p>修改轉發端口<br>修改 /root/lkl/run.sh ，查找 9000-9999 ，改成你想要的端口段</p>
<p>修改 /root/lkl/haproxy.cfg 查找 9000-9999 ，改成你想要的端口段</p>
<p>重啟 vps</p>
<p>安裝 v2ray<br>這裡要注意一下，安裝 v2ray 的端口要在 LKL 轉發的端口範圍內，否則安裝 LKL 也無用。</p>
<hr>
<h2 id="Nginx-安裝"><a href="#Nginx-安裝" class="headerlink" title="Nginx 安裝"></a>Nginx 安裝</h2><p>參考<sup id="fnref:7"><a href="#fn:7" rel="footnote">7</a></sup><sup id="fnref:8"><a href="#fn:8" rel="footnote">8</a></sup></p>
<pre><code>service httpd stop
yum install epel-release
yum -y install nginx
service nginx start
</code></pre><p>設定位置</p>
<pre><code>nano /etc/nginx/nginx.conf


mkdir -p /var/www/yourdomain.com/public_html
</code></pre><p>Let’s create a test index.html in this directory so that we have something to look at when we test the configuration later:</p>
<pre><code>nano /var/www/yourdomain.com/public_html/index.html
</code></pre><p>All we need is a simple line of text to show that the connection is working:</p>
<pre><code>Hello world!
</code></pre><p>Close and save the index.html file.</p>
<p>We need to set permissions for this folder so that it can be viewed by the outside world:</p>
<pre><code>chmod 755 /var/www/yourdomain.com/public_html
</code></pre><p>更改設定檔中的  location / { 為</p>
<p>   /var/www/yourdomain.com/public_html</p>
<hr>
<h2 id="Let’s-Encrypt-安裝"><a href="#Let’s-Encrypt-安裝" class="headerlink" title="Let’s Encrypt 安裝"></a>Let’s Encrypt 安裝</h2><p>參考<sup id="fnref:9"><a href="#fn:9" rel="footnote">9</a></sup><sup id="fnref:10"><a href="#fn:10" rel="footnote">10</a></sup><br>    yum install epel-release<br>    yum install certbot<br>    yum -y install yum-utils<br>    yum-config-manager –enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional<br>    certbot –nginx<br>    certbot –nginx certonly</p>
<pre><code>certbot renew --dry-run
</code></pre><p>證書儲存在：<br>    ssl_certificate: /etc/letsencrypt/live/你的網域/fullchain.pem;<br>    ssl_certificate_key: /etc/letsencrypt/live/你的網域/privkey.pem</p>
<p>NGINX SSL/TLS 設定：</p>
<p>可使用 Security/Server Side TLS – MozillaWiki 提供的介面，自動產生 Apache、NGINX HTTP 網頁伺服器的設定檔</p>
<figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></div><div class="code"><pre><div class="line">[root@img ~]<span class="comment"># vi /etc/nginx/conf.d/default.conf</span></div><div class="line">... 以上省略 ...</div><div class="line"> </div><div class="line">server &#123;</div><div class="line">    <span class="comment"># 使用 https 和 http/2 協定</span></div><div class="line">    listen 443 ssl http2;</div><div class="line">    <span class="comment"># 上述的 IPv6 方式</span></div><div class="line">    listen [::]:443 ssl http2;</div><div class="line"> </div><div class="line">    <span class="comment"># 網站網址</span></div><div class="line">    server_name img.yummygo.com.tw;</div><div class="line">    <span class="comment"># 網站根目錄</span></div><div class="line">    root   /var/nginx/html;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># certs sent to the client in SERVER HELLO are concatenated in ssl_certificate</span></div><div class="line">    <span class="comment">#</span></div><div class="line"> </div><div class="line">    <span class="comment"># SSL 憑證證書路徑</span></div><div class="line">    ssl_certificate /etc/letsencrypt/live/img.yummygo.com.tw/fullchain.pem;</div><div class="line">    <span class="comment"># 私鑰路徑</span></div><div class="line">    ssl_certificate_key /etc/letsencrypt/live/img.yummygo.com.tw/privkey.pem;</div><div class="line">    <span class="comment"># 緩存有效期</span></div><div class="line">    ssl_session_timeout 1d;</div><div class="line">    <span class="comment"># 緩存憑證類型和大小</span></div><div class="line">    ssl_session_cache shared:SSL:50m;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># intermediate configuration. tweak to your needs.</span></div><div class="line">    <span class="comment">#</span></div><div class="line"> </div><div class="line">    <span class="comment"># 使用的加密協定</span></div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    <span class="comment"># 加密演演算法，越前面的優先級越高</span></div><div class="line">    ssl_ciphers <span class="string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS'</span>;</div><div class="line">    <span class="comment"># 交握過程使用 Server 的首選加演演算法，這裡使用 Client 為首選</span></div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line"> </div><div class="line"> </div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)</span></div><div class="line">    <span class="comment">#</span></div><div class="line"> </div><div class="line">    <span class="comment"># 增加 http header</span></div><div class="line">    add_header Strict-Transport-Security max-age=15768000;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>重新啟動 NGINX：</p>
<pre><code>[root@img ~]# systemctl restart nginx
</code></pre><h3 id="防火牆設定"><a href="#防火牆設定" class="headerlink" title="防火牆設定"></a>防火牆設定</h3><p>設定 firewall 允許 https service（Posr 443）：<br>    [root@img ~]# firewall-cmd –permanent –add-service=https –zone=public<br>    [root@img ~]# firewall-cmd –reload</p>
<h4 id="自動續期憑證"><a href="#自動續期憑證" class="headerlink" title="自動續期憑證"></a>自動續期憑證</h4><p>Let’s Encrypt 免費 SSL/TLS 憑證有效期僅有三個月，因此設定排程來自動續期：</p>
<pre><code>[root@img ~]# vi /etc/crontab
</code></pre><figure class="highlight bash"><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></div><div class="code"><pre><div class="line"><span class="comment"># 每月 1 日 03:00 續期憑證，並重啟 Nginx</span></div><div class="line">00 03  1  *  * root /usr/bin/certbot renew --quiet &amp;&amp; /bin/systemctl restart nginx</div></pre></div></div></figure>
<hr>
<h3 id="Proxifier"><a href="#Proxifier" class="headerlink" title="Proxifier"></a>Proxifier</h3><p>全局代理</p>
<hr>
<h2 id="KCP介紹"><a href="#KCP介紹" class="headerlink" title="KCP介紹"></a>KCP介紹</h2><p>轉自<a href="https://github.com/skywind3000/kcp" rel="external nofollow noopener noreferrer" target="_blank">官方</a>，參考<sup id="fnref:11"><a href="#fn:11" rel="footnote">11</a></sup></p>
<p>KCP 是一個快速可靠協定，能以比 TCP 浪費 10%-20% 的帶寬的代價，換取平均延遲降低 30%-40%，且最大延遲降低三倍的傳輸效果。純演算法實現，並不負責底層協定（如 UDP）的收發。</p>
<p>技術特性<br>TCP 是為流量設計的（每秒內可以傳輸多少 KB 的資料），講究的是充分利用帶寬。而 KCP 是為流速設計的（單個資料包從一端發送到一端需要多少時間），以 10%-20% 帶寬浪費的代價換取了比 TCP 快 30%-40% 的傳輸速度。TCP 通道是一條流速很慢，但每秒流量很大的大運河，而 KCP 是水流湍急的小激流。KCP 有正常模式和快速模式兩種，通過以下策略達到提高流速的結果：</p>
<p>RTO 翻倍 vs 不翻倍：<br>TCP 超時計算是 RTOx2，這樣連續丟三次包就變成 RTOx8 了，十分恐怖，而 KCP 啟動快速模式後不 x2，只是 x1.5（實驗證明 1.5 這個值相對比較好），提高了傳輸速度。</p>
<p>選擇性重傳 vs 全部重傳：<br>TCP 丟包時會全部重傳從丟的那個包開始以後的資料，KCP 是選擇性重傳，只重傳真正丟失的資料包。</p>
<p>快速重傳：<br>發送端發送了 1,2,3,4,5 幾個包，然後收到遠端的 ACK: 1, 3, 4, 5，當收到 ACK3 時，KCP 知道 2 被跳過 1 次，收到 ACK4 時，知道 2 被跳過了 2 次，此時可以認為 2 號丟失，不用等超時，直接重傳 2 號包，大大改善了丟包時的傳輸速度。</p>
<p>延遲 ACK vs 非延遲 ACK：<br>TCP 為了充分利用帶寬，延遲發送 ACK（NODELAY 都沒用），這樣超時計算會算出較大 RTT 時間，延長了丟包時的判斷過程。KCP 的 ACK 是否延遲發送可以調節。</p>
<p>UNA vs ACK+UNA：<br>ARQ 模型回應有兩種，UNA（此編號前所有包已收到，如 TCP）和 ACK（該編號包已收到），光用 UNA 將導致全部重傳，光用 ACK 則丟失成本太高，以往協定都是二選其一，而 KCP 協定中，除去單獨的 ACK 包外，所有包都有 UNA 資訊。</p>
<p>非退讓流控：<br>KCP 正常模式同 TCP 一樣使用公平退讓法則，即發送視窗大小由：發送緩存大小、接收端剩餘接收緩存大小、丟包退讓及慢啟動這四要素決定。但傳送及時性要求很高的小資料時，可選擇通過配置跳過後兩步，僅用前兩項來控制發送頻率。以犧牲部分公平性及帶寬利用率之代價，換取了開著 BT 都能流暢傳輸的效果。</p>
<hr>
<h2 id="DNS-CAA"><a href="#DNS-CAA" class="headerlink" title="DNS CAA"></a>DNS CAA</h2><p>以後有機會再使用<br><a href="https://segmentfault.com/a/1190000011097942" rel="external nofollow noopener noreferrer" target="_blank">給你的站點添加 DNS CAA 保護</a></p>
<hr>
<h2 id="現用設定"><a href="#現用設定" class="headerlink" title="現用設定"></a>現用設定</h2><figure class="highlight json"><figcaption><span>Server</span></figcaption><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"log"</span> : &#123;</div><div class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</div><div class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</div><div class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">15674</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"clients"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">          <span class="attr">"alterId"</span>: <span class="number">64</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"mkcp"</span>,</div><div class="line">      <span class="attr">"kcpSettings"</span>: &#123;</div><div class="line">        <span class="attr">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">        <span class="attr">"tti"</span>: <span class="number">20</span>,</div><div class="line">        <span class="attr">"uplinkCapacity"</span>: <span class="number">5</span>,</div><div class="line">        <span class="attr">"downlinkCapacity"</span>: <span class="number">100</span>,</div><div class="line">        <span class="attr">"congestion"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">"readBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"writeBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"header"</span>: &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"none"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outboundDetour"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</div><div class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"tag"</span>: <span class="string">"blocked"</span></div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"routing"</span>: &#123;</div><div class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"rules"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">          <span class="attr">"ip"</span>: [</div><div class="line">            <span class="string">"0.0.0.0/8"</span>,</div><div class="line">            <span class="string">"10.0.0.0/8"</span>,</div><div class="line">            <span class="string">"100.64.0.0/10"</span>,</div><div class="line">            <span class="string">"127.0.0.0/8"</span>,</div><div class="line">            <span class="string">"169.254.0.0/16"</span>,</div><div class="line">            <span class="string">"172.16.0.0/12"</span>,</div><div class="line">            <span class="string">"192.0.0.0/24"</span>,</div><div class="line">            <span class="string">"192.0.2.0/24"</span>,</div><div class="line">            <span class="string">"192.168.0.0/16"</span>,</div><div class="line">            <span class="string">"198.18.0.0/15"</span>,</div><div class="line">            <span class="string">"198.51.100.0/24"</span>,</div><div class="line">            <span class="string">"203.0.113.0/24"</span>,</div><div class="line">            <span class="string">"::1/128"</span>,</div><div class="line">            <span class="string">"fc00::/7"</span>,</div><div class="line">            <span class="string">"fe80::/10"</span></div><div class="line">          ],</div><div class="line">          <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<figure class="highlight json"><figcaption><span>Client</span></figcaption><div class="figcode"><div class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></div><div class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"inbound"</span>: &#123;</div><div class="line">    <span class="attr">"port"</span>: <span class="number">1080</span>,</div><div class="line">    <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"socks"</span>,</div><div class="line">    <span class="attr">"domainOverride"</span>: [<span class="string">"tls"</span>,<span class="string">"http"</span>],</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"auth"</span>: <span class="string">"noauth"</span>,</div><div class="line">      <span class="attr">"udp"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outbound"</span>: &#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"vnext"</span>: [&#123;</div><div class="line">        <span class="attr">"address"</span>: <span class="string">"---"</span>,</div><div class="line">        <span class="attr">"port"</span>: <span class="number">15674</span>,</div><div class="line">        <span class="attr">"users"</span>: [</div><div class="line">          &#123;</div><div class="line">            <span class="attr">"id"</span>: <span class="string">"---"</span>,</div><div class="line">            <span class="attr">"alterID"</span>: <span class="number">64</span></div><div class="line">          &#125;</div><div class="line">        ]</div><div class="line">      &#125;]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"streamSettings"</span>: &#123;</div><div class="line">      <span class="attr">"network"</span>: <span class="string">"mkcp"</span>,</div><div class="line">      <span class="attr">"kcpSettings"</span>: &#123;</div><div class="line">        <span class="attr">"mtu"</span>: <span class="number">1350</span>,</div><div class="line">        <span class="attr">"tti"</span>: <span class="number">20</span>,</div><div class="line">        <span class="attr">"uplinkCapacity"</span>: <span class="number">5</span>,</div><div class="line">        <span class="attr">"downlinkCapacity"</span>: <span class="number">100</span>,</div><div class="line">        <span class="attr">"congestion"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">"readBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"writeBufferSize"</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">"header"</span>: &#123;</div><div class="line">          <span class="attr">"type"</span>: <span class="string">"srtp"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"outboundDetour"</span>: [&#123;</div><div class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</div><div class="line">    <span class="attr">"tag"</span>: <span class="string">"direct"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;&#125;</div><div class="line">  &#125;],</div><div class="line">  <span class="attr">"routing"</span>: &#123;</div><div class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</div><div class="line">    <span class="attr">"settings"</span>: &#123;</div><div class="line">      <span class="attr">"domainStrategy"</span>: <span class="string">"IPOnDemand"</span>,</div><div class="line">      <span class="attr">"rules"</span>: [&#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"field"</span>,</div><div class="line">        <span class="attr">"ip"</span>: [</div><div class="line">          <span class="string">"0.0.0.0/8"</span>,</div><div class="line">          <span class="string">"10.0.0.0/8"</span>,</div><div class="line">          <span class="string">"100.64.0.0/10"</span>,</div><div class="line">          <span class="string">"127.0.0.0/8"</span>,</div><div class="line">          <span class="string">"169.254.0.0/16"</span>,</div><div class="line">          <span class="string">"172.16.0.0/12"</span>,</div><div class="line">          <span class="string">"192.0.0.0/24"</span>,</div><div class="line">          <span class="string">"192.0.2.0/24"</span>,</div><div class="line">          <span class="string">"192.168.0.0/16"</span>,</div><div class="line">          <span class="string">"198.18.0.0/15"</span>,</div><div class="line">          <span class="string">"198.51.100.0/24"</span>,</div><div class="line">          <span class="string">"203.0.113.0/24"</span>,</div><div class="line">          <span class="string">"::1/128"</span>,</div><div class="line">          <span class="string">"fc00::/7"</span>,</div><div class="line">          <span class="string">"fe80::/10"</span></div><div class="line">        ],</div><div class="line">        <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></div><div class="line">      &#125;]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></div></div></figure>
<p>記錄：<br>OpenConnet Server (ocserv) 通過實現 Cisco 的 AnyConnect 協議，用 DTLS 作為主無協議，UPD DTLS 失敗時會轉用 TCP TLS。<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup><br><a href="https://wangwanjie.github.io/2017/07/28/购买BanwagonHOST" rel="external nofollow noopener noreferrer" target="_blank">購買 BanwagonHOST VPS 自建 Shadowsocks 記錄</a></p>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none; padding-left: 0;"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">1.</span><span style="display: inline-block; vertical-align: top;"><a href="https://bitinn.net/11084/" rel="external nofollow noopener noreferrer" target="_blank">加設 OpenConnect Server 給 iPhone 提供更順暢的網路生活</a></span><a href="#fnref:1" rev="footnote"> ↩</a></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">2.</span><span style="display: inline-block; vertical-align: top;"><a href="https://www.v2ray.com/chapter_00/install.html" rel="external nofollow noopener noreferrer" target="_blank">Project V 安裝</a></span><a href="#fnref:2" rev="footnote"> ↩</a></li><li id="fn:3"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">3.</span><span style="display: inline-block; vertical-align: top;"><a href="https://toutyrater.github.io/prep/json.html" rel="external nofollow noopener noreferrer" target="_blank">V2ray 白話教程</a></span><a href="#fnref:3" rev="footnote"> ↩</a></li><li id="fn:4"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">4.</span><span style="display: inline-block; vertical-align: top;"><a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81" rel="external nofollow noopener noreferrer" target="_blank">通用唯一識別碼</a></span><a href="#fnref:4" rev="footnote"> ↩</a></li><li id="fn:5"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">5.</span><span style="display: inline-block; vertical-align: top;"><a href="https://www.aihoom.com/1194.html" rel="external nofollow noopener noreferrer" target="_blank">openVZ 框架安裝 LKL+v2ray 讓你閒置的小記憶體 VPS 翻牆</a></span><a href="#fnref:5" rev="footnote"> ↩</a></li><li id="fn:6"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">6.</span><span style="display: inline-block; vertical-align: top;"><a href="https://zh.wikipedia.org/zh-tw/%E4%BC%A0%E8%BE%93%E5%B1%82" rel="external nofollow noopener noreferrer" target="_blank">傳輸層</a></span><a href="#fnref:6" rev="footnote"> ↩</a></li><li id="fn:7"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">7.</span><span style="display: inline-block; vertical-align: top;"><a href="https://www.godaddy.com/garage/how-to-install-and-configure-nginx-on-centos-7/" rel="external nofollow noopener noreferrer" target="_blank">How to install and configure NGINX on CentOS 7</a></span><a href="#fnref:7" rev="footnote"> ↩</a></li><li id="fn:8"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">8.</span><span style="display: inline-block; vertical-align: top;"><a href="https://smalljacky.com/linux/centos/centos7-nginx-mariadb-php-phpmyadmin/" rel="external nofollow noopener noreferrer" target="_blank">CentOS 7 安裝與設定 Nginx + MariaDB + PHP + phpMyAdmin（LEMP）</a></span><a href="#fnref:8" rev="footnote"> ↩</a></li><li id="fn:9"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">9.</span><span style="display: inline-block; vertical-align: top;"><a href="https://smalljacky.com/linux/centos/centos7-lets-encrypt-https-nginx/" rel="external nofollow noopener noreferrer" target="_blank">CentOS 7 Let’s Encrypt 免費 SSL/TLS 憑證 HTTPS 設置 for NGINX</a></span><a href="#fnref:9" rev="footnote"> ↩</a></li><li id="fn:10"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">10.</span><span style="display: inline-block; vertical-align: top;"><a href="https://certbot.eff.org/lets-encrypt/centosrhel7-nginx" rel="external nofollow noopener noreferrer" target="_blank">Cerbot</a></span><a href="#fnref:10" rev="footnote"> ↩</a></li><li id="fn:11"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">11.</span><span style="display: inline-block; vertical-align: top;"><a href="https://oing9179.github.io/blog/2016/11/v2ray-More-Complex-and-Better-than-Shadowsocks/" rel="external nofollow noopener noreferrer" target="_blank">v2ray - 比 Shadowsocks 更強大更複雜的替代品</a></span><a href="#fnref:11" rev="footnote"> ↩</a></li><li id="fn:12"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">12.</span><span style="display: inline-block; vertical-align: top;"><a href="https://oing9179.github.io/blog/2017/03/v2ray-as-WebSocket-Proxy-behind-Nginx/" rel="external nofollow noopener noreferrer" target="_blank">用 Nginx 轉發 V2Ray 的 WebSocket 連接</a></span><a href="#fnref:12" rev="footnote"> ↩</a></li><li id="fn:13"><span style="display: inline-block; vertical-align: top; padding-right: 10px;">13.</span><span style="display: inline-block; vertical-align: top;"><a href="https://github.com/getlantern/forum/issues/7887" rel="external nofollow noopener noreferrer" target="_blank">翻牆和匿名與網路安全類科普文大集合</a></span><a href="#fnref:13" rev="footnote"> ↩</a></li></ol></div></div>
      
    </div>

    

    
    
    

    

    

    <div>
      
        <div style="text-align:center;color: #ccc;font-size:14px;">------ THE END ------</div>
      
    </div>

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>作者： </strong>Flymia</li>
  <li class="post-copyright-link">
    <strong>文章連結：</strong>
    <a href="https://ppundsh.github.io/posts/e457/" title="V2Ray 記錄">https://ppundsh.github.io/posts/e457/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版權聲明： </strong>本網誌所有文章除特別聲明外，均採用 <a rel="external nofollow noopener noreferrer" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/" target="_blank">創用 CC 姓名標示-非商業性-相同方式分享 3.0 台灣 授權條款</a> 授權<a rel="external nofollow noopener noreferrer" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/" target="_blank"><img alt="創用 CC 授權條款" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" align="right"></a> </li>
</ul>

      </div>
    
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/APP/" rel="tag"><i class="fa fa-tag"></i> APP</a>
          
            <a href="/tags/GFW/" rel="tag"><i class="fa fa-tag"></i> GFW</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/2a39/" rel="next" title="SDN 筆記">
                <i class="fa fa-chevron-left"></i> SDN 筆記
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/4037/" rel="prev" title="Windows Subsystem Linux 筆記">
                Windows Subsystem Linux 筆記 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



  
    <div id="gitalk-container"></div>
  
        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            本站概要
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Flymia</p>
              <p class="site-description motion-element" itemprop="description">MIS、生活、3C</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">文章</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">標籤</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用-Linux-指令"><span class="nav-number">1.</span> <span class="nav-text">常用 Linux 指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用-v2ray-指令"><span class="nav-number">2.</span> <span class="nav-text">常用 v2ray 指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用-Nginx-指令"><span class="nav-number">3.</span> <span class="nav-text">常用 Nginx 指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CentOS-7-安裝-V2Ray"><span class="nav-number">4.</span> <span class="nav-text">CentOS 7 安裝 V2Ray</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON"><span class="nav-number">4.1.</span> <span class="nav-text">JSON</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中國地區不翻牆"><span class="nav-number">4.2.</span> <span class="nav-text">中國地區不翻牆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#廣告過濾"><span class="nav-number">4.3.</span> <span class="nav-text">廣告過濾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inbound-outbound-和-inboundDetour-outboundDetour-的區別"><span class="nav-number">4.4.</span> <span class="nav-text">inbound / outbound 和 inboundDetour / outboundDetour 的區別</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V2Ray-高級設置"><span class="nav-number">5.</span> <span class="nav-text">V2Ray 高級設置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mux-多路復用-multiplexing"><span class="nav-number">5.1.</span> <span class="nav-text">Mux 多路復用 (multiplexing)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mKCP"><span class="nav-number">5.2.</span> <span class="nav-text">mKCP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#動態端口"><span class="nav-number">5.3.</span> <span class="nav-text">動態端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#動態端口使用-mKCP"><span class="nav-number">5.4.</span> <span class="nav-text">動態端口使用 mKCP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#傳出代理"><span class="nav-number">5.5.</span> <span class="nav-text">傳出代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-偽裝"><span class="nav-number">5.6.</span> <span class="nav-text">HTTP 偽裝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TLS"><span class="nav-number">5.7.</span> <span class="nav-text">TLS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-註冊一個域名"><span class="nav-number">5.7.1.</span> <span class="nav-text">1.1. 註冊一個域名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-證書生成"><span class="nav-number">5.7.2.</span> <span class="nav-text">1.2. 證書生成</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-1-安裝-acme-sh"><span class="nav-number">5.7.2.1.</span> <span class="nav-text">1.2.1. 安裝 acme.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-2-使用-acme-sh-生成證書"><span class="nav-number">5.7.2.2.</span> <span class="nav-text">1.2.2. 使用 acme.sh 生成證書</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#證書更新"><span class="nav-number">5.7.2.3.</span> <span class="nav-text">證書更新</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-3-安裝證書和密鑰"><span class="nav-number">5.7.2.4.</span> <span class="nav-text">1.2.3. 安裝證書和密鑰</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-配置-V2Ray"><span class="nav-number">5.7.3.</span> <span class="nav-text">1.3. 配置 V2Ray</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-驗證"><span class="nav-number">5.7.4.</span> <span class="nav-text">1.4. 驗證</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebSocket"><span class="nav-number">5.8.</span> <span class="nav-text">WebSocket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WebSocket-TLS-Web"><span class="nav-number">5.9.</span> <span class="nav-text">WebSocket+TLS+Web</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-2"><span class="nav-number">5.10.</span> <span class="nav-text">HTTP/2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不推薦的配置"><span class="nav-number">5.11.</span> <span class="nav-text">不推薦的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#透明代理"><span class="nav-number">5.12.</span> <span class="nav-text">透明代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-部署-V2Ray"><span class="nav-number">6.</span> <span class="nav-text">Docker 部署 V2Ray</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BBR"><span class="nav-number">7.</span> <span class="nav-text">BBR</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-安裝"><span class="nav-number">8.</span> <span class="nav-text">Nginx 安裝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Let’s-Encrypt-安裝"><span class="nav-number">9.</span> <span class="nav-text">Let’s Encrypt 安裝</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#防火牆設定"><span class="nav-number">9.1.</span> <span class="nav-text">防火牆設定</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自動續期憑證"><span class="nav-number">9.1.1.</span> <span class="nav-text">自動續期憑證</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Proxifier"><span class="nav-number">9.2.</span> <span class="nav-text">Proxifier</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KCP介紹"><span class="nav-number">10.</span> <span class="nav-text">KCP介紹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS-CAA"><span class="nav-number">11.</span> <span class="nav-text">DNS CAA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#現用設定"><span class="nav-number">12.</span> <span class="nav-text">現用設定</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Flymia</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">網站總字數：</span>
    
    <span title="網站總字數">177k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">網站總閱讀時間：</span>
    
    <span title="網站總閱讀時間">14:44</span>
  
</div>


  



<!--  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 強力驅動 v3.7.1</div>

-->





        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  



  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://rawgit.com/ppundsh/f359785730acb0fbfdee07eb12522623/raw/15ce7e5ea97e7afb71792d58a21978f225195a12/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '93c9fec1508ce54e67f0',
          clientSecret: 'c9c33bdfef68c346a41d6ed48e594a2428ce3b1e',
          repo: 'ppundsh.github.io',
          owner: 'ppundsh',
          admin: ['ppundsh'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.1.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.1.0"></script>


  

  


  <script type="text/javascript" src="/lib/zclip/clipboard.min.js"></script>	
<script type="text/javascript" src="/js/src/custom.js"></script>

</body>
</html>
